## A (Caller)  ‚Üí  SIP Server (Asterisk/FreeSWITCH)  ‚Üí  B (Receiver)

STEP 1 ‚Äî Caller Sends INVITE

1Ô∏è‚É£ INVITE
Caller sends:
```
INVITE sip:1001@server
```
Purpose: Start a call
Includes: SDP (media, codecs, RTP ports)

STEP 2 ‚Äî Server Responds with Provisional Responses

2Ô∏è‚É£ 100 Trying
Server is processing the INVITE:
```
100 Trying
```
Meaning:
‚úî I received your INVITE
‚úî I‚Äôm checking routing
‚úî No ringing yet

3Ô∏è‚É£ 180 Ringing

Receiver's phone is ringing
```
180 Ringing
```

Meaning:
‚úî Phone is alerting
‚úî Caller hears RING tone

4Ô∏è‚É£ 183 Session Progress

Call is progressing with early media.
```
183 Session Progress
```

Meaning:
‚úî Call not answered yet
‚úî Media can flow (IVR, announcements, ringback, etc.)

üîπ STEP 3 ‚Äî Receiver Answers
5Ô∏è‚É£ 200 OK

Receiver accepted the call.
```
200 OK
```

Meaning:
‚úî Call is answered
‚úî Media (RTP) can start

200 OK contains the callee SDP (RTP ports, codec).


üîπ STEP 4 ‚Äî ACK & Media
6Ô∏è‚É£ ACK

Caller acknowledges the 200 OK.
```
ACK
```

Meaning:
‚úî Session established
‚úî Voice audio (RTP) starts

üîπ STEP 5 ‚Äî RTP MEDIA
```
A <---- RTP (Voice) ----> B
```
This is your voice.

üîπ STEP 6 ‚Äî Call End
7Ô∏è‚É£ BYE (Hangup)

Either party hangs up.
```
BYE
```

8Ô∏è‚É£ 200 OK (to BYE)

Call ended successfully.
```
200 OK
```

Full Flow 

```
A ‚Üí INVITE ‚Üí SERVER ‚Üí INVITE ‚Üí B
A ‚Üê 100 Trying ‚Üê SERVER ‚Üê 100 Trying ‚Üê B
A ‚Üê 180 Ringing ‚Üê SERVER ‚Üê 180 Ringing ‚Üê B
A ‚Üê 200 OK ‚Üê SERVER ‚Üê 200 OK ‚Üê B
A ‚Üí ACK ‚Üí SERVER ‚Üí ACK ‚Üí B
A ‚Üî RTP ‚Üî SERVER ‚Üî RTP ‚Üî B
A ‚Üí BYE ‚Üí SERVER ‚Üí BYE ‚Üí B
A ‚Üê 200 OK ‚Üê SERVER ‚Üê 200 OK ‚Üê B
```

ALL IMPORTANT SIP STATUS CODES
1xx ‚Äî Provisional
Code	Meaning
100 Trying	Received INVITE
180 Ringing	Phone ringing
181 Call is Being Forwarded	Call forwarding
183 Session Progress	Early media
2xx ‚Äî Success
Code	Meaning
200 OK	Success (INVITE, BYE, REGISTER, etc.)
202 Accepted	Request accepted for processing
3xx ‚Äî Redirection
Code	Meaning
300 Multiple Choices	
301 Moved Permanently	
302 Moved Temporarily	Call forwarding by SIP server
4xx ‚Äî Client Error (your fault)
Code	Meaning
400 Bad Request	Syntax error
401 Unauthorized	Need password
403 Forbidden	Wrong credentials
404 Not Found	Extension not found
407 Proxy Authentication Required	
408 Request Timeout	No response
415 Unsupported Media	Codec mismatch
480 Temporarily Unavailable	
486 Busy Here	User busy
488 Not Acceptable Here	SDP/codec mismatch
5xx ‚Äî Server Error
Code	Meaning
500 Server Internal Error	
501 Not Implemented	
503 Service Unavailable	Asterisk overload / trunk down
6xx ‚Äî Global Failure
Code	Meaning
603 Decline	User rejected call
604 Does Not Exist Anywhere	
606 Not Acceptable	
üìû Short Explanation: Why SIP Call Fails?
Common Real Issues:

404 ‚Üí wrong extension

480 ‚Üí SIP peer unreachable

486 ‚Üí busy

488/415 ‚Üí codec issue

503 ‚Üí carrier problem



RTP FLOW DIAGRAM (Direct Media)
```
Caller (1001)                Callee (1002)
     |                             |
     |--- INVITE (SDP Offer) ----->|
     |<-- 200 OK (SDP Answer) -----|
     |-------- ACK ---------------->|
     |                             |
     |<====== RTP AUDIO ==========>|
     |   Direct Media, UDP         |
```
‚úî After ACK, RTP starts
‚úî Audio flows directly if NAT allows it

NAT FLOW (RTP via Asterisk)
When NAT blocks direct RTP, Asterisk acts as a RTP proxy.
```
Caller -------- INVITE ---------> Asterisk -------- INVITE ---------> Receiver
  |                                 |                                |
  |<---------- 200 OK --------------|------------ 200 OK ------------|
  |------------- ACK -------------->|------------- ACK ------------->|
  |                                 |                                |
  |==== RTP ====> Asterisk <==== RTP =====> Receiver
```
‚úî Asterisk rewrites SDP
‚úî Asterisk bridges RTP streams
‚úî Solves NAT / firewall issues

SIP + WebRTC (DTLS + SRTP + ICE) FLOW
```
WebRTC Client                  Asterisk                   SIP Phone
     |                             |                           |
     |----- DTLS Offer ------------>|                           |
     |                             |                           |
     |<---- DTLS Answer ----------- |                           |
     |                             |                           |
     |------ INVITE (ICE) -------->| ----- INVITE (SDP) ------>|
     |<------ 183 w/ICE -----------|<------ 183 ---------------|
     |                             |                           |
     |-------- STUN/TURN ICE Conn Checks ----------------------|
     |                             |                           |
     |<============ SRTP =========>|<========= RTP ===========>|
```
‚úî WebRTC uses

DTLS-SRTP

ICE

STUN/TURN
‚úî Asterisk can bridge to SIP/RTP

SIP REGISTRATION FLOW
```
SIP Phone (1001)         Asterisk SIP Server
      |                         |
      |---- REGISTER ---------->|
      |                         |
      |<---- 401 Unauthorized --|
      |---- REGISTER + Auth --->|
      |                         |
      |<----- 200 OK -----------|
      |   Registered Successfully|
```
‚úî All SIP phones must register
‚úî 401 challenge ensures authentication

CALL TRANSFER FLOW (Attended)
```
A (Caller)                Agent B                     Agent C (Transfer Target)
     |                       |                                  |
     |------- INVITE ------->|                                  |
     |<------ 200 OK --------|                                  |
     |--------- ACK -------->|                                  |
     |<====== RTP ==========>|                                  |
     |                       |------- INVITE ------------------>|
     |                       |<------ 200 OK -------------------|
     |                       |---------- ACK ------------------->|
     |                       |<==== RTP (B <-> C) =============>|
     |
     |<-- REFER (Refer-To: C) from B
     |
     |------ INVITE to C ---------------->|
     |<------ 200 OK ---------------------|
     |----------- ACK --------------------|
     |<======= RTP (A <-> C) =============|
```
‚úî Attended transfer involves:

INVITE B

INVITE C

REFER to A
‚úî RTP flows switch from B‚ÜíC to A‚ÜíC

VICIDIAL CALL FLOW (CAMPAIGN ‚Üí AGENT)
A. Agent Logs In
```
Agent Phone ---> Asterisk ----> Vicidial DB
     |               |               |
     |--- REGISTER --|               |
     |<-- 200 OK ----|               |
     |--- Login via Web ------------>|
     |--- Update Agent Status ------>|
```
B. Vicidial Dials Leads Automatically
```
Vicidial Dialer Engine -----> Asterisk -----> Carrier -----> Customer
        |                        |                 |
        |--- Originate Call ---->|--- INVITE ----->|
        |<-- 200 OK / RTP -------|<-- 200 OK ------|
```
‚úî Carrier connects customer
‚úî Asterisk sends call status to Vicidial manager port (5038 AMI)

C. Vicidial Connects Agent
```
Customer <===== RTP =====> Asterisk <===== RTP =====> Agent
```
Flow:

Dialer calls agent phone (SIP or WebRTC)

Agent auto-answers (via AMD or auto-call)

Vicidial bridges customer + agent

D. Call Disconnection
```
Customer Hangup ----> Asterisk ----> Vicidial  
Agent Hangup --------> Asterisk ----> Vicidial
```

‚úî Status stored in vicidial_closer_log / vicidial_log
‚úî Call recording saved

